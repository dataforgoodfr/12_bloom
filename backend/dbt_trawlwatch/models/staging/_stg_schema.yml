version: 2

models:
  ### PORTS
  - name: seed_dim_ports
    description: "Staged model from seed for ports data, used for staging and analysis"
    columns:
      - name: port_id
        description: "Unique identifier for each port (based on UN/LOCODE)"
        tests:
          - not_null
          - unique
      - name: port_name
        description: "Name of the port"
      - name: port_country_iso3
        description: "ISO3 code of the country where the port is located"
        tests: 
          - not_null
      - name: port_locode
        description: "UN/LOCODE of the port, used as a unique identifier"
        tests:
          - not_null    
          - unique
      - name: port_latitude
        description: "Latitude of the port location"
        tests:
          - not_null
      - name: port_longitude
        description: "Longitude of the port location"  
        tests:
          - not_null 
      - name: port_url
        description: "URL for more information about the port"
      - name: port_has_excursions
        description: "Indicates if the port has excursions (boolean) - NOT USED at this stage"
      - name: port_created_at
        description: "Timestamp when the port record was created in the database"
        tests:
          - not_null
      - name: port_updated_at
        description: "Timestamp when the port record was last updated in the database" 
      - name: port_geometry_point
        description: "Geometric representation of the port location (POINT, WGS84 format)"
        tests:
          - not_null
  ### VESSELS
  - name: seed_static_dim_vessels
    description: "Static staged model from seed for vessels data, consolidated with historical vessels data further down the pipeline"
    columns:
      - name: vessel_id
        description: "Unique identifier for each vessel (CFR or user-defined identifier (fishing vessel type + rank))"
        tests:
          - not_null
          - unique
      - name: dim_vessel_name
        description: "Name of the ship"
        tests:
          - not_null
      - name: dim_vessel_flag
        description: "Flag of the ship, represented by the ISO3 code of the country"
        tests:
          - not_null:
              config:
                severity: warn
      - name: dim_vessel_imo
        description: "IMO number of the vessel, used as a unique identifier"
        tests:
          - not_null
          - unique:
              config: 
                severity: warn
      - name: dim_vessel_cfr
        description: "CFR number of the vessel (EU identifier)"
        tests:
          - unique:
              config: 
                severity: warn
      - name: dim_vessel_call_sign
        description: "Call sign of the vessel, used for identification"
      - name: dim_vessel_external_marking
        description: "External marking of the vessel, used for identification"
      - name: dim_vessel_loa
        description: "Length overall of the vessel in meters"
      - name: dim_vessel_start_date
        description: "Start date of the vessel's operational period (if available)"
        tests:
          - dbt_utils.expression_is_true:
              expression: "is null"
      - name: dim_vessel_end_date
        description: "End date of the vessel's operational period (if available)"
        tests:
          - dbt_utils.expression_is_true:
              expression: "is null"
      - name: tracking_activated
        description: "Indicates if the vessel is actively tracked in Trawl Watch(boolean)"
        tests:
          - not_null
          - accepted_values:
              values: [true]
              quote: false
      - name: tracking_status
        description: "Status of the vessel's tracking (e.g., 'active', 'inactive')"
      - name: dim_vessel_source
        description: "Source of the vessel data & informations"
      - name: dim_vessel_origin
        description: "Origin of the vessel data (STATIC | HISTORIZED | SPIRE_AIS_DATA)"
      - name: dim_vessel_details
        description: "JSON object containing additional details about the vessel, such as gear, width, length class, and ship type"
      - name: seed_static_dim_vessel_created_at
        description: "Timestamp when the vessel record was created in the database"

  - name: seed_historical_dim_vessels
    description: "Historical staged model from seed for vessels data, consolidated with static vessels data further down the pipeline"
    columns:
      - name: vessel_id
        description: "Unique identifier for each vessel (CFR or user-defined identifier (fishing vessel type + rank))"
        tests:
          - not_null
      - name: dim_vessel_name
        description: "Name of the ship"
        tests:
          - not_null
      - name: dim_vessel_flag
        description: "Flag of the ship, represented by the ISO3 code of the country"
        tests:
          - not_null:
              config:
                severity: warn
      - name: dim_vessel_imo
        description: "IMO number of the vessel, used as a unique identifier"
        tests:
          - not_null:
              config:
                severity: warn
      - name: dim_vessel_cfr
        description: "CFR number of the vessel (EU identifier)"
        tests:
          - unique:
              config:
                severity: warn
      - name: dim_vessel_call_sign
        description: "Call sign of the vessel, used for identification"
      - name: dim_vessel_external_marking
        description: "External marking of the vessel, used for identification"
      - name: dim_vessel_loa
        description: "Length overall of the vessel in meters"
      - name: dim_vessel_start_date
        description: "Start date of the vessel's operational period (if available)"
      - name: dim_vessel_end_date
        description: "End date of the vessel's operational period (if available)"
      - name: tracking_activated
        description: "Indicates if the vessel is actively tracked in Trawl Watch(boolean)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              quote: false
      - name: tracking_status
        description: "Status of the vessel's tracking (e.g., 'active', 'inactive')"
      - name: dim_vessel_source
        description: "Source of the vessel data & informations"
      - name: dim_vessel_origin
        description: "Origin of the vessel data (STATIC | HISTORIZED | SPIRE_AIS_DATA)"
      - name: dim_vessel_details
        description: "JSON object containing additional details about the vessel, such as gear, width, length class, and ship type"
      - name: dim_vessel_created_at
        description: "Timestamp when the vessel record was created in the database"
        tests:
          - not_null
  - name: stg_dim_vessels
    description: "Staging model for vessels data, used for staging and analysis"
    config:
      tags: ['staging', 'vessels']
      materialized: view
    columns:
      - name: vessel_id
        description: "Unique identifier for each vessel (CFR or user-defined identifier (fishing vessel type + rank))"
        tests:
          - not_null
      - name: dim_vessel_name
        description: "Name of the ship"
        tests:
          - not_null
      - name: dim_vessel_flag
        description: "Flag of the ship, represented by the ISO3 code of the country"
        tests:
          - not_null:
              config:
                severity: warn
      - name: dim_vessel_imo
        description: "IMO number of the vessel, used as a unique identifier"
        tests:
          - not_null:
              config:
                severity: warn
      - name: dim_vessel_cfr
        description: "CFR number of the vessel (EU identifier)"
      - name: dim_vessel_call_sign
        description: "Call sign of the vessel, used for identification"
      - name: dim_vessel_external_marking
        description: "External marking of the vessel, used for identification"
      - name: dim_vessel_loa
        description: "Length overall of the vessel in meters"
      - name: dim_vessel_start_date
        description: "Start date of the vessel's operational period (if available)"
      - name: dim_vessel_end_date
        description: "End date of the vessel's operational period (if available)"
      - name: tracking_activated
        description: "Indicates if the vessel is actively tracked in Trawl Watch(boolean)"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              quote: false 
      - name: dim_vessel_status
        description: "Status of the vessel's tracking (e.g., 'active', 'inactive')"
      - name: dim_vessel_source
        description: "Source of the vessel data & informations"
      - name: dim_vessel_origin
        description: "Origin of the vessel data (STATIC | HISTORIZED | SPIRE_AIS_DATA)"
        tests:
          - not_null
          - accepted_values:
              values: ['STATIC', 'HISTORIZED', 'SPIRE_AIS_DATA']
              quote: true
              config:
                severity: warn
      - name: dim_vessel_details
        description: "JSON object containing additional details about the vessel, such as gear, length class, and ship type"  
      - name: stg_dim_vessel_created_at
        description: "Timestamp when the vessel record was created in the database"
        tests:
          - not_null

  #### MMSI
  - name: seed_historical_dim_mmsi
    description: "Seed model for historical MMSI - vessel_id association, consolidated with static MMSI data further down the pipeline"
    columns:
      - name: vessel_id
        description: "Unique identifier for each vessel"
        tests:
          - not_null
      - name: dim_mmsi_mmsi
        description: "MMSI of the vessel"
        tests:
          - not_null
      - name: dim_mmsi_start_date
        description: "Start date of the MMSI's operational period (if available)"
        tests: 
          - not_null
      - name: dim_mmsi_end_date
        description: "End date of the MMSI's operational period (if available)"
      - name: dim_mmsi_details
        description: "Context of MMSI termination"
      - name: dim_mmsi_created_at
        description: "Timestamp when the record was created in the database"
        tests:
          - not_null

  - name: seed_static_dim_mmsi
    description: "Seed model for static MMSI - vessel_id association, consolidated with historical MMSI data further down the pipeline"
    columns:
      - name: vessel_id
        description: "Unique identifier for each vessel"
        tests:
          - not_null
          - unique
      - name: dim_mmsi_mmsi
        description: "MMSI of the vessel"
        tests:
          - not_null
          - unique
      - name: dim_mmsi_start_date
        description: "Start date of the MMSI's operational period (if available)"
        tests: 
          - dbt_utils.expression_is_true:
              expression: "is null"
      - name: dim_mmsi_end_date
        description: "End date of the MMSI's operational period (if available)"
        tests: 
          - dbt_utils.expression_is_true:
              expression: "is null"
      - name: dim_mmsi_details
        description: "Context of MMSI termination"
      - name: dim_mmsi_created_at
        description: "Timestamp when the record was created in the database"
        tests:
          - not_null

  - name: stg_dim_mmsi
    description: "Staging model for MMSI data, used for staging and analysis"
    columns:
      - name: vessel_id
        description: "Unique identifier for each vessel"
        tests:
          - not_null
      - name: dim_mmsi_mmsi
        description: "MMSI of the vessel"
        tests:
          - not_null
      - name: dim_mmsi_start_date
        description: "Start date of the MMSI's operational period (if available)"
      - name: dim_mmsi_end_date
        description: "End date of the MMSI's operational period (if available)"
      - name: dim_mmsi_details
        description: "Context of MMSI termination"
      - name: stg_dim_mmsi_created_at
        description: "Timestamp when the record was created in the database"
        tests:
          - not_null
  ### ZONES
  - name: stg_dim_zones
    description: "Staging model for zones data, used for staging and analysis"
    config:
      tags: ['staging', 'zones']
      materialized: view
    columns:
      - name: zone_id
        description: "Unique identifier for each zone"
        tests:
          - not_null
          - unique
      - name: zone_name
        description: "Name of the zone"
        tests:
          - not_null
      - name: zone_category
        description: "Category of the zone (amp | Clipped territorial seas | Fishing coastal waters (6-12NM) | Territorial seas)"
        tests:
          - not_null
      - name: zone_sub_category
        description: "Sub-category of the zone (only for 'amp' category)"
      - name: zone_json_data
        description: "JSON data containing additional information about the zone"
      - name: zone_created_at
        description: "Timestamp when the zone record was created in the database"
        tests:
          - not_null
      - name: zone_updated_at
        description: "Timestamp when the zone record was last updated in the database"
      - name: zone_enable
        description: "Indicates if the zone is enabled (boolean). Filtered on true only"
        tests:
          - not_null
          - accepted_values:
              values: [true]
              quote: false 
      - name: zone_centroid
        description: "Centroid of the zone (POINT, WGS84 format)"
        tests:
          - not_null
      - name: zone_geometry
        description: "Geometric representation of the zone (POLYGON, WGS84 format)"
        tests:
          - not_null

  ### VESSEL POSITIONS
  - name: stg_vessel_positions
    description: "Staging partitioned incremental model for vessel positions derived from Spire AIS data with vessel_id"
    config:
      tags: ['staging', 'vessel', 'positions']
      materialized: incremental
      unique_key: ['position_id', 'position_timestamp', 'position_timestamp_month']
      pre-hook:
        - "SELECT staging.ensure_stg_vessel_positions_future_partitions();"
    columns:
      - name: position_id
        description: "Unique identifier for each position record"
        tests:
          - not_null
      - name: position_timestamp
        description: "Timestamp of the position record"
        tests:
          - not_null
      - name: position_mmsi
        description: "MMSI of the vessel at the time of the position record"
      - name: vessel_id
        description: "Unique identifier for the vessel"
        tests:
          - not_null
      - name: position_latitude
        description: "Latitude of the vessel's position"
        tests:
          - not_null
      - name: position_longitude
        description: "Longitude of the vessel's position"
        tests:
          - not_null

      - name: position_speed
        description: "Speed of the vessel at the time of the position record"
      - name: position_heading
        description: "Heading of the vessel at the time of the position record"
      - name: position_course
        description: "Course over ground of the vessel at the time of the position record"
      - name: position_rot
        description: "Rate of turn of the vessel at the time of the position record"
      - name: position_ais_created_at_min
        description: "Min timestamp when this AIS messages gave the position"
      - name: position_ais_created_at_max
        description: "Max timestamp when this AIS messages gave the position"
      - name: position_timestamp_month
        description: "Month when this AIS data was created, used for partitioning"
        tests:
          - not_null
      - name: position_timestamp_day
        description: "Day when this AIS data was created, used for partitioning"
        tests:
          - not_null
      - name : position_point
        description: "Geometric representation of the vessel's position (POINT, WGS84 format)"